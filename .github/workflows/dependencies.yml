name: Dependencies Update

on:
  schedule:
    # –ö–∞–∂–¥—É—é –Ω–µ–¥–µ–ª—é –≤ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –≤ 9:00 UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–ø—É—Å–∫–∞ –≤—Ä—É—á–Ω—É—é

jobs:
  # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
  update-dependencies:
    name: üì¶ Update Dependencies
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Configure git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Install dependencies
        run: npm ci

      - name: Check for outdated packages
        id: outdated
        run: |
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –ø–∞–∫–µ—Ç—ã
          OUTDATED=$(npm outdated --json || echo '{}')
          echo "outdated_packages<<EOF" >> $GITHUB_OUTPUT
          echo "$OUTDATED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –ø–∞–∫–µ—Ç–æ–≤
          COUNT=$(echo "$OUTDATED" | jq 'length' 2>/dev/null || echo 0)
          echo "outdated_count=$COUNT" >> $GITHUB_OUTPUT

      - name: Security audit
        id: audit
        run: |
          # –ó–∞–ø—É—Å–∫–∞–µ–º audit –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
          AUDIT_RESULT=$(npm audit --json || echo '{"vulnerabilities": {}}')
          echo "audit_result<<EOF" >> $GITHUB_OUTPUT
          echo "$AUDIT_RESULT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —É—è–∑–≤–∏–º–æ—Å—Ç–∏
          HIGH_VULNS=$(echo "$AUDIT_RESULT" | jq '.metadata.vulnerabilities.high // 0' 2>/dev/null || echo 0)
          CRITICAL_VULNS=$(echo "$AUDIT_RESULT" | jq '.metadata.vulnerabilities.critical // 0' 2>/dev/null || echo 0)
          echo "high_vulnerabilities=$HIGH_VULNS" >> $GITHUB_OUTPUT
          echo "critical_vulnerabilities=$CRITICAL_VULNS" >> $GITHUB_OUTPUT

      - name: Create update branch
        if: steps.outdated.outputs.outdated_count > 0
        run: |
          BRANCH_NAME="dependencies/update-$(date +%Y-%m-%d)"
          git checkout -b "$BRANCH_NAME"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Update minor and patch versions
        if: steps.outdated.outputs.outdated_count > 0
        run: |
          # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ minor –∏ patch –≤–µ—Ä—Å–∏–∏ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
          npm update --save

      - name: Fix security vulnerabilities
        if: steps.audit.outputs.high_vulnerabilities > 0 || steps.audit.outputs.critical_vulnerabilities > 0
        run: |
          npm audit fix --audit-level=high --force || true

      - name: Run tests after updates
        if: steps.outdated.outputs.outdated_count > 0
        run: |
          npm test || {
            echo "‚ùå Tests failed after dependency updates"
            echo "TESTS_FAILED=true" >> $GITHUB_ENV
          }

      - name: Check if build works
        if: steps.outdated.outputs.outdated_count > 0
        run: |
          npm run build || {
            echo "‚ùå Build failed after dependency updates"
            echo "BUILD_FAILED=true" >> $GITHUB_ENV
          }

      - name: Generate update summary
        if: steps.outdated.outputs.outdated_count > 0
        run: |
          echo "# üì¶ –û—Ç—á–µ—Ç –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π" > UPDATE_SUMMARY.md
          echo "" >> UPDATE_SUMMARY.md
          echo "**–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> UPDATE_SUMMARY.md
          echo "**–û–±–Ω–æ–≤–ª–µ–Ω–æ –ø–∞–∫–µ—Ç–æ–≤**: ${{ steps.outdated.outputs.outdated_count }}" >> UPDATE_SUMMARY.md
          echo "" >> UPDATE_SUMMARY.md

          if [ "${{ steps.audit.outputs.critical_vulnerabilities }}" -gt 0 ] || [ "${{ steps.audit.outputs.high_vulnerabilities }}" -gt 0 ]; then
            echo "## üö® –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏" >> UPDATE_SUMMARY.md
            echo "- **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ**: ${{ steps.audit.outputs.critical_vulnerabilities }}" >> UPDATE_SUMMARY.md
            echo "- **–í—ã—Å–æ–∫–∏–µ**: ${{ steps.audit.outputs.high_vulnerabilities }}" >> UPDATE_SUMMARY.md
            echo "" >> UPDATE_SUMMARY.md
          fi

          echo "## üìã –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø–∞–∫–µ—Ç—ã" >> UPDATE_SUMMARY.md
          echo "" >> UPDATE_SUMMARY.md
          echo '```json' >> UPDATE_SUMMARY.md
          echo '${{ steps.outdated.outputs.outdated_packages }}' | jq '.' >> UPDATE_SUMMARY.md 2>/dev/null || echo "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –ø–∞–∫–µ—Ç–æ–≤" >> UPDATE_SUMMARY.md
          echo '```' >> UPDATE_SUMMARY.md
          echo "" >> UPDATE_SUMMARY.md

          if [ "$TESTS_FAILED" = "true" ]; then
            echo "## ‚ùå –í–Ω–∏–º–∞–Ω–∏–µ: —Ç–µ—Å—Ç—ã —É–ø–∞–ª–∏" >> UPDATE_SUMMARY.md
            echo "–ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ç–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ—à–ª–∏ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π. –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞." >> UPDATE_SUMMARY.md
            echo "" >> UPDATE_SUMMARY.md
          fi

          if [ "$BUILD_FAILED" = "true" ]; then
            echo "## ‚ùå –í–Ω–∏–º–∞–Ω–∏–µ: —Å–±–æ—Ä–∫–∞ —É–ø–∞–ª–∞" >> UPDATE_SUMMARY.md
            echo "–°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π. –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä—É—á–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ." >> UPDATE_SUMMARY.md
            echo "" >> UPDATE_SUMMARY.md
          fi

          echo "## ‚úÖ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏" >> UPDATE_SUMMARY.md
          echo "1. –ü—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —ç—Ç–æ–º PR" >> UPDATE_SUMMARY.md
          echo "2. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ" >> UPDATE_SUMMARY.md
          echo "3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ" >> UPDATE_SUMMARY.md
          echo "4. –ü—Ä–∏ —É—Å–ø–µ—à–Ω—ã—Ö —Ç–µ—Å—Ç–∞—Ö, merge —ç—Ç–æ—Ç PR" >> UPDATE_SUMMARY.md

      - name: Commit changes
        if: steps.outdated.outputs.outdated_count > 0
        run: |
          git add package.json package-lock.json

          COMMIT_MSG="chore(deps): update dependencies"
          if [ "${{ steps.audit.outputs.critical_vulnerabilities }}" -gt 0 ] || [ "${{ steps.audit.outputs.high_vulnerabilities }}" -gt 0 ]; then
            COMMIT_MSG="$COMMIT_MSG and fix security vulnerabilities"
          fi

          git commit -m "$COMMIT_MSG

          - Updated ${{ steps.outdated.outputs.outdated_count }} packages
          - Fixed ${{ steps.audit.outputs.critical_vulnerabilities }} critical and ${{ steps.audit.outputs.high_vulnerabilities }} high vulnerabilities

          Auto-generated by GitHub Actions"

          git push origin "$BRANCH_NAME"

      - name: Create Pull Request
        if: steps.outdated.outputs.outdated_count > 0
        uses: repo-sync/pull-request@v2
        with:
          source_branch: ${{ env.BRANCH_NAME }}
          destination_branch: 'main'
          pr_title: 'üì¶ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ)'
          pr_body_path: 'UPDATE_SUMMARY.md'
          pr_assignee: ${{ github.repository_owner }}
          pr_label: 'dependencies,automated'
          github_token: ${{ secrets.GITHUB_TOKEN }}

  # –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
  security-check:
    name: üîí Weekly Security Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Security audit
        run: |
          echo "## üîí –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏" > SECURITY_REPORT.md
          echo "" >> SECURITY_REPORT.md
          echo "**–î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> SECURITY_REPORT.md
          echo "" >> SECURITY_REPORT.md

          # –ó–∞–ø—É—Å–∫–∞–µ–º audit
          if npm audit --audit-level=low > audit_output.txt 2>&1; then
            echo "‚úÖ **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –£—è–∑–≤–∏–º–æ—Å—Ç–∏ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã" >> SECURITY_REPORT.md
          else
            echo "‚ö†Ô∏è **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏" >> SECURITY_REPORT.md
            echo "" >> SECURITY_REPORT.md
            echo "### –î–µ—Ç–∞–ª–∏:" >> SECURITY_REPORT.md
            echo '```' >> SECURITY_REPORT.md
            cat audit_output.txt >> SECURITY_REPORT.md
            echo '```' >> SECURITY_REPORT.md
          fi

          echo "" >> SECURITY_REPORT.md
          echo "### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:" >> SECURITY_REPORT.md
          echo "- –†–µ–≥—É–ª—è—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è–π—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏" >> SECURITY_REPORT.md
          echo "- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ npm audit fix –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π" >> SECURITY_REPORT.md
          echo "- –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ GitHub Security Advisories" >> SECURITY_REPORT.md

      - name: Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: security-report-$(date +%Y-%m-%d)
          path: SECURITY_REPORT.md
          retention-days: 30

      - name: Create issue for critical vulnerabilities
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'üö® –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏';
            const body = `
            ## üîí –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

            **–î–∞—Ç–∞**: ${new Date().toISOString()}

            –í–æ –≤—Ä–µ–º—è –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –±—ã–ª–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏.

            ### –î–µ–π—Å—Ç–≤–∏—è:
            1. –ü—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –æ—Ç—á–µ—Ç –≤ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞—Ö —ç—Ç–æ–≥–æ workflow
            2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ \`npm audit\` –ª–æ–∫–∞–ª—å–Ω–æ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
            3. –í—ã–ø–æ–ª–Ω–∏—Ç–µ \`npm audit fix\` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            4. –î–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤ –æ–±–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é

            ### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è:
            - –≠—Ç–æ—Ç issue –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã—Ç –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–π —É—Å–ø–µ—à–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ
            - Workflow –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è –∏—Å–ø—Ä–∞–≤–∏—Ç—å —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

            ---
            *–°–æ–∑–¥–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ GitHub Actions*
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['security', 'automated', 'high-priority']
            });
